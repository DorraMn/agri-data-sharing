package com.example.demo.service;

import com.example.demo.client.ProducteurClient;
import com.example.demo.entity.JeuDonnees;
import com.example.demo.repository.JeuDonneesRepository;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;

@Service
public class JeuDonneesService {

    private final JeuDonneesRepository repository;
    private final ProducteurClient producteurClient;

    public JeuDonneesService(JeuDonneesRepository repository,
                             ProducteurClient producteurClient) {
        this.repository = repository;
        this.producteurClient = producteurClient;
    }

    public JeuDonnees publier(JeuDonnees jeuDonnees) {

        // Appel synchrone via Feign
        String role = producteurClient.getRole(jeuDonnees.getProducteurId());

        if (!"AGRICULTEUR".equalsIgnoreCase(role)) {
            throw new RuntimeException("Producteur non autorisé à publier");
        }

        jeuDonnees.setDatePublication(LocalDate.now());
        return repository.save(jeuDonnees);
    }

    public List<JeuDonnees> findAll() {
        return repository.findAll();
    }
}
